#include <Servo.h>

// ---------------- PINS ----------------
#define TRIG_PIN 9
#define ECHO_PIN 8
#define MOISTURE_PIN A0
#define SERVO_PIN 10

// ---------------- OBJECTS ----------------
Servo sorterServo;

// ---------------- MOISTURE CALIBRATION ----------------
int dryValue = 450;
int wetValue = 250;
int threshold;

// ---------------- VARIABLES ----------------
long duration;
int distance;
int moisture;

// ---------------- STATES ----------------
bool objectDetected = false;
bool sortingDone = false;

void setup() {
  Serial.begin(9600);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  sorterServo.attach(SERVO_PIN);
  sorterServo.write(45);   // neutral

  threshold = (dryValue + wetValue) / 2;

  Serial.println("SYSTEM READY â€“ WAITING FOR OBJECT");
}

void loop() {

  // ================= STEP 1: WAIT FOR OBJECT =================
  if (!objectDetected) {

    digitalWrite(TRIG_PIN, LOW);
    delayMicroseconds(2);
    digitalWrite(TRIG_PIN, HIGH);
    delayMicroseconds(10);
    digitalWrite(TRIG_PIN, LOW);

    duration = pulseIn(ECHO_PIN, HIGH, 30000);
    distance = duration * 0.034 / 2;

    Serial.print("Distance: ");
    Serial.println(distance);

    if (distance > 0 && distance <= 10) {
      objectDetected = true;   // LOCK ultrasonic
      Serial.println("Object detected â†’ waiting for moisture contact");
      delay(500);
    }

    return;  // ðŸ”´ STOP HERE (ultrasonic waits)
  }

  // ================= STEP 2: WAIT FOR MOISTURE =================
  if (!sortingDone) {

    moisture = analogRead(MOISTURE_PIN);
    Serial.print("Moisture reading: ");
    Serial.println(moisture);

    // wait until sensor touches object
    if (moisture >= wetValue && moisture <= dryValue) {

      if (moisture > threshold) {
        Serial.println("DRY OBJECT â†’ DRY BIN");
        sorterServo.write(0);
      } else {
        Serial.println("WET OBJECT â†’ WET BIN");
        sorterServo.write(90);
      }

      sortingDone = true;
      delay(2000);

      sorterServo.write(45);   // neutral
      delay(1500);

      Serial.println("SORTING DONE");
    }

    return;  // ðŸ”´ STOP HERE (waits for moisture)
  }

  // ================= STEP 3: RESET SYSTEM =================
  objectDetected = false;
  sortingDone = false;
  Serial.println("SYSTEM RESET â€“ WAITING FOR NEXT OBJECT");
  delay(1000);
}
